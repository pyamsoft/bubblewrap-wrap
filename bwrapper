#!/bin/sh
#
# The GPLv2 License
#
#   Copyright (C) 2019  Peter Kenji Yamanaka
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License along
#   with this program; if not, write to the Free Software Foundation, Inc.,
#   51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

# bwrapper - autogenerate bww scripts

__PROGRAM_NAME="$(basename "$0")"

print_usage()
{
  printf -- '%s\n\n' "$(cat << EOF
usage: ${__PROGRAM_NAME} <program> [argument-string]

  argument-string can be any normal command line arguments you
  pass if you were calling bww from the command line.

  All arguments in the argument-string are passed to bww, not to <program>

  A proxy command is generated called by "<program> shell" which launches a
  --shell into the bww jail for <program>

EOF
)"
  bww --help || return 1
  return 0
}

main()
{
  command_name="$1"
  shift

  if [ -z "${command_name}" ]; then
    printf -- 'Must specify a command\n\n'
    print_usage || return 1
    return 1
  fi

  if [ "${command_name}" = "--help" ]; then
    print_usage || return 1
    return 0
  fi

  # Loop and consume arguments until we can't anymore

  if ! command -v "${command_name}" > /dev/null 2>&1; then
    printf -- 'Invalid command: %s\n\n' "${command_name}"
    print_usage || return 1
    return 1
  fi

  target_file="./${command_name}"
  if [ -f "${target_file}" ]; then
    printf -- 'Remove old file at %s...\n' "${target_file}"
    rm -f "${target_file}" || return 1
  fi

  printf -- 'Output to %s...\n' "${target_file}"
  cat > "${target_file}" << EOF
#!/bin/sh

# This file is autogenerated by ${__PROGRAM_NAME}, modifications may be
# overwritten by the script.

# This script expects the 'bww' script to be available to the user somewhere
# on the \$PATH. It will fail if the situation proves otherwise.

readonly arguments="$@"
readonly command_name="${command_name}"

if [ "\$1" = "--" ]; then
  # Stop bww argument parsing (in case the command you want to run is actually called "shell")
  # To pass a '--' argument to the wrapped program, you must pass -- again so
  #
  # \$ my_program -A -B -C -- x y z      =>
  # \$ my_program -- -A -B -C -- x y z
  shift

  # shellcheck disable=SC2086
  exec bww \$arguments "\${command_name}" "\$@"
elif [ "\$1" = "shell" ]; then
  # Launch a shell in the environment
  shift

  # No extra arguments for shells

  # shellcheck disable=SC2086
  exec bww \$arguments --shell "\${command_name}"
else
  # shellcheck disable=SC2086
  exec bww \$arguments \"${command_name}" "\$@"
fi
EOF

  printf -- 'Mark %s as executable...\n' "${target_file}"
  chmod 700 "${target_file}" || return 1

  printf -- 'Generated: '%s'.\n' "${target_file}"
  return 0
}

main "$@" || exit 1
exit 0
